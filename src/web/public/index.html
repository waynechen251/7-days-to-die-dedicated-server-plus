<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>7 Days To Die Dedicated Server Plus æ§åˆ¶å°</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
        background-color: #f8f8f8;
      }

      h2 {
        margin-top: 2rem;
        color: #333;
      }

      button {
        margin: 0.5rem 0.25rem;
        padding: 0.5rem 1rem;
      }

      textarea {
        width: 100%;
        height: 40vh;
        font-family: monospace;
        white-space: pre-wrap;
        resize: none;
      }
    </style>
  </head>
  <body>
    <h1>7 Days To Die Dedicated Server Plus æ§åˆ¶é¢æ¿</h1>

    <h2>âš™ï¸ å®‰è£æˆ–æ›´æ–° Dedicated Server</h2>
    <button id="installServerBtn">ğŸ“¥ å®‰è£ / æ›´æ–° Dedicated Server</button>
    <select id="versionSelect">
      <option value="">Stable (public)</option>
      <option value="v2.0">v2.0 Stable</option>
      <option value="v2.1">v2.1 Stable</option>
      <option value="v1.4">v1.4 Stable</option>
      <option value="v1.3">v1.3 Stable</option>
    </select>

    <h2>ğŸ—‚ï¸ ç®¡ç†å¾Œå°</h2>
    <div>
      <button id="viewConfigBtn">âš™ï¸ æŸ¥çœ‹ç®¡ç†å¾Œå°è¨­å®š</button>
      <button id="viewSavesBtn">ğŸ“‚ æŸ¥çœ‹ä¼ºæœå™¨å­˜æª”æ¸…å–®</button>
      <button id="backupBtn">ğŸ’¾ å‚™ä»½ä¼ºæœå™¨å­˜æª”</button>
      <button id="startServerGUIBtn">â–¶ï¸ å•Ÿå‹•ä¼ºæœå™¨(GUI)</button>
      <button id="startServerNOGUIBtn">â–¶ï¸ å•Ÿå‹•ä¼ºæœå™¨(NO GUI)</button>
      <button id="stopServerBtn">â¹ï¸ é—œé–‰ä¼ºæœå™¨</button>
    </div>

    <h2>ğŸ“¡ ä¼ºæœå™¨è³‡è¨Š</h2>
    <div>
      <button onclick="sendTelnet('version')">ğŸ” æŸ¥çœ‹ç‰ˆæœ¬</button>
      <button onclick="sendTelnet('listplayers')">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ç©å®¶æ¸…å–®</button>
      <button onclick="sendTelnet('getgamepref')">âš™ï¸ æŸ¥çœ‹ä¼ºæœå™¨è¨­å®š</button>
    </div>

    <textarea
      id="output"
      readonly
    ></textarea>

    <script>
      async function fetchApi(url, options = {}) {
        const res = await fetch(url, options);
        const text = await res.text();
        document.getElementById("output").value = text;
      }

      function viewSaves() {
        fetchApi("/api/view-saves", { method: "POST" });
      }

      function viewConfig() {
        fetch("/api/view-config", { method: "POST" })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            document.getElementById("output").value = JSON.stringify(
              data,
              null,
              2
            );
          })
          .catch((err) => {
            document.getElementById("output").value =
              "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
          });
      }

      const installServerBtn = document.getElementById("installServerBtn");
      const backupBtn = document.getElementById("backupBtn");
      const viewConfigBtn = document.getElementById("viewConfigBtn");
      const viewSavesBtn = document.getElementById("viewSavesBtn");
      const startServerGUIBtn = document.getElementById("startServerGUIBtn");
      const startServerNOGUIBtn = document.getElementById(
        "startServerNOGUIBtn"
      );
      const stopServerBtn = document.getElementById("stopServerBtn");
      const versionSelect = document.getElementById("versionSelect");

      installServerBtn.addEventListener("click", () => {
        fetchApi("/api/install", {
          method: "POST",
          body: JSON.stringify({ version: versionSelect.value }),
        });
      });

      async function onBackupClick() {
        backupBtn.disabled = true;
        backupBtn.textContent = "å‚™ä»½ä¸­â€¦";

        const timeoutMs = 30_000;
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);

        const output = document.getElementById("output");

        try {
          const res = await fetch("/api/backup", {
            method: "POST",
            signal: controller.signal,
          });
          const text = await res.text();
          output.value = text; // å°‡çµæœé¡¯ç¤ºåœ¨ console å€å¡Š
        } catch (err) {
          if (err.name === "AbortError") {
            output.value = "âŒ å·²è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦";
          } else {
            output.value = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
          }
        } finally {
          clearTimeout(timer);
          backupBtn.disabled = false;
          backupBtn.textContent = "ğŸ’¾ å‚™ä»½ä¼ºæœå™¨å­˜æª”";
        }
      }

      function startServerGUI() {
        fetchApi("/api/start", {
          method: "POST",
          body: JSON.stringify({ nographics: false }),
        });
      }

      function startServerNOGUI() {
        fetchApi("/api/start", {
          method: "POST",
          body: JSON.stringify({ nographics: true }),
        });
      }

      function stopServer() {
        fetchApi("/api/stop", { method: "POST" });
      }

      function sendTelnet(cmd) {
        fetchApi("/api/telnet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: cmd }),
        });
      }

      // ç¶å®šæŒ‰éˆ•äº‹ä»¶
      backupBtn.addEventListener("click", onBackupClick);
      viewSavesBtn.addEventListener("click", viewSaves);
      startServerGUIBtn.addEventListener("click", startServerGUI);
      startServerNOGUIBtn.addEventListener("click", startServerNOGUI);
      stopServerBtn.addEventListener("click", stopServer);
      viewConfigBtn.addEventListener("click", viewConfig);
    </script>
  </body>
</html>
